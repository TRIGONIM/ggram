<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<head>
    <title>ggram documentation</title>
    <link rel="stylesheet" href="../ldoc.css" type="text/css" />
</head>
<body>

<div id="container">

<div id="product">
	<div id="product_logo"></div>
	<div id="product_name"><big><b></b></big></div>
	<div id="product_description"></div>
</div> <!-- id="product" -->


<div id="main">


<!-- Menu -->

<div id="navigation">
<br/>
<h1>ggram</h1>


<ul>
  <li><a href="../index.html">Index</a></li>
</ul>

<h2>Contents</h2>
<ul>
<li><a href="#Tables">Tables</a></li>
<li><a href="#Methods">Methods</a></li>
<li><a href="#Basic_Handlers">Basic Handlers </a></li>
</ul>


<h2>Classes</h2>
<ul class="nowrap">
  <li><strong>Bot</strong></li>
  <li><a href="../classes/Context.html">Context</a></li>
  <li><a href="../classes/Reply.html">Reply</a></li>
</ul>
<h2>Modules</h2>
<ul class="nowrap">
  <li><a href="../modules/deferred.html">deferred</a></li>
  <li><a href="../modules/ggram.html">ggram</a></li>
</ul>
<h2>Topics</h2>
<ul class="">
  <li><a href="../topics/readme.md.html">readme</a></li>
  <li><a href="../topics/development_tips.md.html">development_tips</a></li>
  <li><a href="../topics/making_extensions.md.html">making_extensions</a></li>
  <li><a href="../topics/running_within_garrysmod.md.html">running_within_garrysmod</a></li>
  <li><a href="../topics/troubleshooting.md.html">troubleshooting</a></li>
  <li><a href="../topics/understanding_things.md.html">understanding_things</a></li>
</ul>
<h2>Examples</h2>
<ul class="nowrap">
  <li><a href="../examples/_micro_tricks.lua.html">_micro_tricks.lua</a></li>
  <li><a href="../examples/co_reply.lua.html">co_reply.lua</a></li>
  <li><a href="../examples/echo.lua.html">echo.lua</a></li>
  <li><a href="../examples/inline_keyboard.lua.html">inline_keyboard.lua</a></li>
  <li><a href="../examples/middlewares.lua.html">middlewares.lua</a></li>
  <li><a href="../examples/send_multipart.lua.html">send_multipart.lua</a></li>
</ul>

</div>

<div id="content">

<h1>Class <code>Bot</code></h1>
<p>Объект бота, создается через ggram()</p>
<p> ⚠️ Все методы здесь определяются через bot:method, но для вызова нужно использовать bot.method</p>


<h2><a href="#Tables">Tables</a></h2>
<table class="function_list">
	<tr>
	<td class="name" nowrap><a href="#.ErrCtx">.ErrCtx</a></td>
	<td class="summary">Таблица, которая передается в <code>bot.handle_error(err_ctx)</code>.</td>
	</tr>
</table>
<h2><a href="#Methods">Methods</a></h2>
<table class="function_list">
	<tr>
	<td class="name" nowrap><a href="#bot:reply">bot:reply (chat_id)</a></td>
	<td class="summary">Возвращает объект-конструктор запроса к Telegram API.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#bot:call_method">bot:call_method (method, parameters[, http_struct_overrides])</a></td>
	<td class="summary">Выполняет http запрос к Telegram API</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#bot:handle_error">bot:handle_error (err_ctx)</a></td>
	<td class="summary">Обработка ошибки запроса к Telegram API.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#bot:handle_middleware_error">bot:handle_middleware_error (err)</a></td>
	<td class="summary">Обработка Lua ошибок внутри хендлеров.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#bot:handle_update">bot:handle_update (UPD)</a></td>
	<td class="summary">Выполняется, когда бот получает update.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#bot:on">bot:on (fFilter, handler, uid)</a></td>
	<td class="summary">Добавляет в бот хендлер на указанных условиях.</td>
	</tr>
</table>
<h2><a href="#Basic_Handlers">Basic Handlers </a></h2>
<table class="function_list">
	<tr>
	<td class="name" nowrap><a href="#bot:update">bot:update (handler, uid)</a></td>
	<td class="summary">Перехватывает все апдейты.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#bot:command">bot:command (name, handler)</a></td>
	<td class="summary">Перехватывает команды бота</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#bot:callback">bot:callback (handler, uid)</a></td>
	<td class="summary">Нажата inline кнопка</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#bot:text">bot:text (handler, uid)</a></td>
	<td class="summary">Пришло текстовое сообщение.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#bot:message">bot:message (handler, uid)</a></td>
	<td class="summary">Команды, гифки...</td>
	</tr>
</table>

<br/>
<br/>


    <h2 class="section-header "><a name="Tables"></a>Tables</h2>

    <dl class="function">
    <dt>
    <a name = ".ErrCtx"></a>
    <strong>.ErrCtx</strong>
    </dt>
    <dd>
    Таблица, которая передается в <code>bot.handle_error(err_ctx)</code>.


    <h3>Fields:</h3>
    <ul>
        <li><span class="parameter">retry</span>
            <span class="types"><span class="type">func</span></span>
        , при вызове которой запрос повторится с теми же параметрами (полезно при retry-after ошибках)
        </li>
        <li><span class="parameter">method</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.4/manual.html#6.4">string</a></span>
         API метод, который бот пытался выполнить при запросе
        </li>
        <li><span class="parameter">parameters</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.4/manual.html#6.6">table</a></span>
         таблица параметров
        </li>
        <li><span class="parameter">try</span>
            <span class="types"><span class="type">int</span></span>
         номер попытки выполнения запроса
        </li>
        <li><span class="parameter">error</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.4/manual.html#6.6">table</a></span>
         ошибка в чистом виде, которая получена от Telegram после выполнения запроса
        </li>
    </ul>





</dd>
</dl>
    <h2 class="section-header "><a name="Methods"></a>Methods</h2>

    <dl class="function">
    <dt>
    <a name = "bot:reply"></a>
    <strong>bot:reply (chat_id)</strong>
    </dt>
    <dd>
    Возвращает объект-конструктор запроса к Telegram API.
 Прикрепляется к каждому ctx объекту.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">chat_id</span>
            <span class="types"><span class="type">int</span></span>
         ID пользователя, чата, канала, для которого будет выполняться API запрос
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

           <span class="types"><a class="type" href="../classes/Reply.html#">Reply</a></span>
        Перейдите по ссылке, чтобы посмотреть примеры использования
    </ol>



    <h3>Usage:</h3>
    <ul>
        <pre class="example">bot.<span class="function-name">reply</span>(<span class="number">123456</span>).<span class="function-name">text</span>(<span class="string">"Hello"</span>)</pre>
    </ul>

</dd>
    <dt>
    <a name = "bot:call_method"></a>
    <strong>bot:call_method (method, parameters[, http_struct_overrides])</strong>
    </dt>
    <dd>
    Выполняет http запрос к Telegram API


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">method</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.4/manual.html#6.4">string</a></span>
         название API метода. Например, sendMessage
        </li>
        <li><span class="parameter">parameters</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.4/manual.html#6.6">table</a></span>
         ключ-значение таблица с параметрами запроса. Например, {chat_id = 12345, text = "Hello"}
        </li>
        <li><span class="parameter">http_struct_overrides</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.4/manual.html#6.6">table</a></span>
         ggram использует функцию HTTP. Вы можете перезаписать любой параметр, который перечислен тут: https://wiki.facepunch.com/gmod/Structures/HTTPRequest
         (<em>optional</em>)
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

           <span class="types"><span class="type">Promise</span></span>
        deferred object
    </ol>



    <h3>Usage:</h3>
    <ul>
        <pre class="example">bot.<span class="function-name">call_method</span>(<span class="string">"setWebhook"</span>, {url = <span class="string">"https://example.com"</span>})</pre>
    </ul>

</dd>
    <dt>
    <a name = "bot:handle_error"></a>
    <strong>bot:handle_error (err_ctx)</strong>
    </dt>
    <dd>
    Обработка ошибки запроса к Telegram API.
 Функция для оверрайда. Вызывается, когда Telegram вернул ошибку после запроса.
 По умолчанию принтит все данные об ошибке в консоль


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">err_ctx</span>
            <span class="types"><a class="type" href="../classes/Bot.html#.ErrCtx">.ErrCtx</a></span>
         параметр отличается от обычного ctx
        </li>
    </ul>




    <h3>Usage:</h3>
    <ul>
        <pre class="example"><span class="keyword">local</span> defer = <span class="global">require</span>(<span class="string">"deferred"</span>)
<span class="keyword">function</span> bot.<span class="function-name">handle_error</span>(ctx)
	<span class="keyword">local</span> err = ctx.<span class="global">error</span>
	<span class="keyword">if</span> err.extra <span class="keyword">and</span> err.extra.http_error <span class="keyword">then</span>
		<span class="keyword">return</span> defer.<span class="function-name">sleep</span>(<span class="number">5</span>):<span class="global">next</span>(ctx.retry)
	<span class="keyword">elseif</span> err.error_code == <span class="number">429</span> <span class="keyword">then</span>
		<span class="keyword">return</span> defer.<span class="function-name">sleep</span>(err.parameters.retry_after):<span class="global">next</span>(ctx.retry)
	<span class="keyword">end</span>
	<span class="global">error</span>(err)
<span class="keyword">end</span></pre>
    </ul>

</dd>
    <dt>
    <a name = "bot:handle_middleware_error"></a>
    <strong>bot:handle_middleware_error (err)</strong>
    </dt>
    <dd>
    Обработка Lua ошибок внутри хендлеров.
 Функция для оверрайда. Вызывается, когда pcall(handler) получил ошибку.
 Ошибка в обработке команды/callback_query и тд.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">err</span>
            <span class="types"><span class="type">any</span></span>
         Результат неудачного выполнения pcall на хендлере
        </li>
    </ul>




    <h3>Usage:</h3>
    <ul>
        <pre class="example"><span class="comment">-- Отправка данных об ошибке в Telegram через отдельный бот
</span><span class="keyword">local</span> report_bot = <span class="global">require</span>(<span class="string">"ggram"</span>)(<span class="string">"1234:token"</span>)
<span class="keyword">local</span> BOT_MT = <span class="global">require</span>(<span class="string">"ggram.bot"</span>)
<span class="keyword">function</span> BOT_MT:<span class="function-name">handle_middleware_error</span>(err)
	<span class="keyword">local</span> errtrace = <span class="string">"@"</span> .. self.username .. <span class="string">" error: "</span> .. <span class="global">debug</span>.<span class="function-name">traceback</span>(err)
	report_bot.<span class="function-name">reply</span>(<span class="number">123456</span>).<span class="function-name">text</span>(errtrace) <span class="comment">-- chat_id
</span>	<span class="global">print</span>(<span class="string">"[ggram] "</span> .. errtrace)
<span class="keyword">end</span></pre>
    </ul>

</dd>
    <dt>
    <a name = "bot:handle_update"></a>
    <strong>bot:handle_update (UPD)</strong>
    </dt>
    <dd>
    Выполняется, когда бот получает update.
 Можно вызывать самостоятельно, чтобы организовать вебхуки или свою реализацию поллинга.
 Внутри получает подходящие под update хендлеры и передает им update объект, обернутый в <a href="../classes/Context.html#">Context</a> (ctx).


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">UPD</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.4/manual.html#6.6">table</a></span>
         update объект от Telegram
        </li>
    </ul>





</dd>
    <dt>
    <a name = "bot:on"></a>
    <strong>bot:on (fFilter, handler, uid)</strong>
    </dt>
    <dd>
    Добавляет в бот хендлер на указанных условиях.
 На основе этой функции созданы все хендлеры: bot.command, bot.callback, bot.update и т.д.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">fFilter</span>
            <span class="types"><span class="type">func</span></span>
         сюда передается <a href="../classes/Context.html#">Context</a> (ctx). Если вернуть true, то выполнится handler(ctx)
        </li>
        <li><span class="parameter">handler</span>
            <span class="types"><span class="type">func</span></span>
         выполнятся, если fFilter вернул true
        </li>
        <li><span class="parameter">uid</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.4/manual.html#6.4">string</a></span>
         уникальный идентификатор хендлера. Не должен повторяться для одного бота
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

           <span class="types"><a class="type" href="../classes/Bot.html#">Bot</a></span>
        self
    </ol>



    <h3>Usage:</h3>
    <ul>
        <pre class="example"><span class="comment">-- Вот так реализован bot.command хендлер:
</span><span class="keyword">local</span> BOT_MT = <span class="global">require</span>(<span class="string">"ggram.bot"</span>)
<span class="keyword">function</span> BOT_MT:<span class="function-name">command</span>(name, handler)
	<span class="keyword">return</span> self.<span class="function-name">on</span>(<span class="keyword">function</span>(ctx)
		<span class="keyword">return</span> ctx.command == name
	<span class="keyword">end</span>, handler, <span class="string">"command_"</span> .. name)
<span class="keyword">end</span></pre>
    </ul>

</dd>
</dl>
    <h2 class="section-header has-description"><a name="Basic_Handlers"></a>Basic Handlers </h2>

          <div class="section-description">
           Основные хендлеры, созданы через <a href="../classes/Bot.html#bot:on">bot:on</a>
          </div>
    <dl class="function">
    <dt>
    <a name = "bot:update"></a>
    <strong>bot:update (handler, uid)</strong>
    </dt>
    <dd>
    Перехватывает все апдейты.  Хорошее место, чтобы добавлять общие middlewares


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">handler</span>
            <span class="types"><span class="type">func</span></span>
         колбек функция, которая выполнится при получении нового update от telegram
        </li>
        <li><span class="parameter">uid</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.4/manual.html#6.4">string</a></span>
         уникальный идентификатор хендлера
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

           <span class="types"><a class="type" href="../classes/Bot.html#">Bot</a></span>
        self
    </ol>


    <h3>See also:</h3>
    <ul>
         <a href="../classes/Bot.html#bot:on">bot:on</a>
    </ul>


</dd>
    <dt>
    <a name = "bot:command"></a>
    <strong>bot:command (name, handler)</strong>
    </dt>
    <dd>
    Перехватывает команды бота


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">name</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.4/manual.html#6.4">string</a></span>
         команда, при получении которой выполнять handler
        </li>
        <li><span class="parameter">handler</span>
            <span class="types"><span class="type">func</span></span>
         колбек функция, которая выполнится при получении указанной команды
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

           <span class="types"><a class="type" href="../classes/Bot.html#">Bot</a></span>
        self
    </ol>



    <h3>Usage:</h3>
    <ul>
        <pre class="example">bot.<span class="function-name">command</span>(<span class="string">"test"</span>, <span class="keyword">function</span>(ctx) ctx.reply.<span class="function-name">text</span>(<span class="string">"Hello"</span>) <span class="keyword">end</span>)</pre>
    </ul>

</dd>
    <dt>
    <a name = "bot:callback"></a>
    <strong>bot:callback (handler, uid)</strong>
    </dt>
    <dd>
    Нажата inline кнопка


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">handler</span>
            <span class="types"><span class="type">func</span></span>
         функция, которая выполнится при нажатии inline кнопок
        </li>
        <li><span class="parameter">uid</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.4/manual.html#6.4">string</a></span>
         уникальный идентификатор хендлера
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

           <span class="types"><a class="type" href="../classes/Bot.html#">Bot</a></span>
        self
    </ol>



    <h3>Usage:</h3>
    <ul>
        <pre class="example">bot.<span class="function-name">command</span>(<span class="string">"test"</span>, <span class="keyword">function</span>(ctx)
	ctx.reply.<span class="function-name">inlineKeyboard</span>({ {
		{text = <span class="string">"Line 1, row 1"</span>, callback_data = <span class="string">"any"</span>},
	} }).<span class="function-name">text</span>(<span class="string">"Hello world!"</span>)
<span class="keyword">end</span>)
bot.<span class="function-name">callback</span>(<span class="keyword">function</span>(ctx)
	<span class="keyword">local</span> query = ctx.callback_query
	<span class="keyword">if</span> query.data == <span class="string">"any"</span> <span class="keyword">then</span>
		ctx.<span class="function-name">answer</span>({text = <span class="string">"It's inline answer"</span>})
	<span class="keyword">end</span>
<span class="keyword">end</span>, <span class="string">"callback_example"</span>)</pre>
    </ul>

</dd>
    <dt>
    <a name = "bot:text"></a>
    <strong>bot:text (handler, uid)</strong>
    </dt>
    <dd>
    Пришло текстовое сообщение.  Может также содержать команду.
 Не gif, не callback_query и т.д.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">handler</span>
            <span class="types"><span class="type">func</span></span>
         функция, которая выполнится при получении текстового сообщения
        </li>
        <li><span class="parameter">uid</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.4/manual.html#6.4">string</a></span>
         уникальный идентификатор хендлера
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

           <span class="types"><a class="type" href="../classes/Bot.html#">Bot</a></span>
        self
    </ol>




</dd>
    <dt>
    <a name = "bot:message"></a>
    <strong>bot:message (handler, uid)</strong>
    </dt>
    <dd>
    Команды, гифки...  Все, что имеет поле .message


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">handler</span>
            <span class="types"><span class="type">func</span></span>
         функция, которая выполнится при получении update с полем .message
        </li>
        <li><span class="parameter">uid</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.4/manual.html#6.4">string</a></span>
         уникальный идентификатор хендлера
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

           <span class="types"><a class="type" href="../classes/Bot.html#">Bot</a></span>
        self
    </ol>




</dd>
</dl>


</div> <!-- id="content" -->
</div> <!-- id="main" -->
<div id="about">
<i>generated by <a href="http://github.com/lunarmodules/LDoc">LDoc 1.5.0</a></i>
<i style="float:right;">Last updated 2023-07-17 02:47:10 </i>
</div> <!-- id="about" -->
</div> <!-- id="container" -->
</body>
</html>
